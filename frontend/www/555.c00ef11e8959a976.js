"use strict";(self.webpackChunkfisheye=self.webpackChunkfisheye||[]).push([[555],{555:(J,L,l)=>{l.r(L),l.d(L,{ExplorationModule:()=>B});var T=l(177),A=l(668),w=l(5596),x=l(882),F=l(6600),y=l(5084),S=l(3881),p=l(9417),h=l(8244),d=l(6974),k=l(9172),P=l(6354),G=l(3678),t=l(7705),z=l(7606);let Y=(()=>{class r{constructor(){this.dMax=2439.9774,this.interval=0}setMap(e){this.map=e}getMap(){return this.map}setCanvas(e){this.canvas=e}getCanvas(){return this.canvas}setContext(e){this.context=e}getContext(){return this.context}setDMax(e){this.dMax=e}getDMax(){return this.dMax}setRenderer(e){this.renderer=e}getRenderer(){return this.renderer}setData(e){this.data=e}getData(){return this.data}setInterval(e){this.interval=e}getInterval(){return this.interval}static{this.\u0275fac=function(n){return new(n||r)}}static{this.\u0275prov=t.jDH({token:r,factory:r.\u0275fac,providedIn:"root"})}}return r})();var I=l(2798),M=l(4518),R=l(9631),V=l(7575),O=l(2765);function $(r,b){1&r&&(t.j41(0,"mat-error"),t.EFF(1,"Invalid start date"),t.k0s())}function N(r,b){1&r&&(t.j41(0,"mat-error"),t.EFF(1,"Invalid end date"),t.k0s())}function X(r,b){if(1&r&&(t.j41(0,"mat-option",26),t.EFF(1),t.k0s()),2&r){const e=b.$implicit;t.Y8G("value",e.viewValue),t.R7$(1),t.SpI(" ",e.viewValue," ")}}const W=[{path:"",component:(()=>{class r{constructor(e,n){this.ds=e,this.es=n,this.dMax=2439.9774,this.loaded=!1,this.intervalLength=5,this.min_color="orange",this.max_color="purple",this.faoURL="https://www.fao.org/fishery/geoserver/fifao/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=fifao%3AFAO_AREAS_ERASE_LOWRES&maxFeatures=50&outputFormat=application%2Fjson",this.minDate=new Date("2017-01-01"),this.maxDate=new Date("2020-12-31"),this.sliderMax=(this.maxDate.getTime()-this.minDate.getTime())/864e5+1,this.sliderVal=1,this.mapScale="log",this.range=new p.J3({start:new p.hs,end:new p.hs}),this.faoChecked=!1,this.faoDisabled=!0,this.countryControl=new p.hs,this.options1=G,this.sliderForm=new p.J3({sliderControl:new p.hs([20,50])}),this.sliderDisplay=this.sliderDisplay.bind(this)}ngOnInit(){const e=this;this.filteredOptions=this.countryControl.valueChanges.pipe((0,k.Z)(""),(0,P.T)(o=>"string"==typeof o?o:o.name),(0,P.T)(o=>o?this._filter(o):this.options1.slice())),this.map=h.map("map",{worldCopyJump:!0}).setView([18,0],2.5);const a=h.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{minZoom:2,maxZoom:10,attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'});this.map.attributionControl.setPosition("bottomleft"),a.addTo(this.map),h.canvas().addTo(this.map),h.svg().addTo(this.map),this.es.setMap(this.map),this.canvas=d.Ltv(this.map.getPanes().overlayPane).select("canvas").attr("z-index",300),this.es.setCanvas(this.canvas),this.context=this.canvas.node().getContext("2d"),this.es.setContext(this.context),this.tooltip=d.Ltv("#tooltip").attr("class","leaflet-interactive").style("visibility","hidden").style("background-color","white").style("border","solid").style("border-width","1px").style("border-radius","5px").style("padding","10px").style("opacity",.7).style("z-index",9999),this.legend=d.Ltv("#legend").attr("height",360).attr("width",90),d.Pq9(this.faoURL).then(o=>{this.faoDisabled=!1,this.ds.setJson(o)});const i="2020-03-01",s="2020-03-05";this.getData(i,s),this.es.setInterval(this.dateRangeToInterval(new Date(i),new Date(s))),this.sliderVal=this.dateToVal(new Date(i)),this.range.setValue({start:i,end:s}),this.countryControl.setValue("World"),this.map.on("click",function(o){console.log(o);const m=e.es.getData(),g=e.truncate(Math.round(100*(o.latlng.lat+.1))/100),C=e.truncate(o.latlng.lng);if(void 0!==m){const c=m.find(v=>v.lat==g&&v.lon==C);void 0!==c?e.tooltip.style("position","absolute").style("z-index",9999).style("visibility","visible").style("left",o.originalEvent.pageX+20+"px").style("top",o.originalEvent.pageY+20+"px").html("Latitude: "+c.lat+"<br>Longitude: "+c.lon+"<br>Fishing Hours: "+Math.round(100*c.tfh)/100):e.tooltip.style("visibility","hidden")}})}_filter(e){const n=e.toLowerCase();return this.options1.filter(a=>a.viewValue.toLowerCase().includes(n))}getData(e,n){const a=this;this.showProgress(),this.map=this.es.getMap();const i=this.es.getContext(),s=this.es.getCanvas();function C(u){let f;"log"==a.mapScale?f=d.aX1():"sqrt"==a.mapScale?f=d.Bv9():"linear"==a.mapScale&&(f=d.m4Y()),f.domain([0,a.dMax]).range(["orange","purple"]);const E=a.map.latLngToLayerPoint(h.latLng(u.lat,u.lon)).y+.1,j=a.map.latLngToLayerPoint(h.latLng(u.lat,u.lon)).x;i.beginPath(),i.fillStyle=f(u.tfh),i.rect(j,E,a.detSize(u)[0],a.detSize(u)[1]),i.fill(),i.closePath()}function c(){i.clearRect(0,0,s.attr("width"),s.attr("height"))}this.ds.getDateRangeVal(e,n,this.countryControl.value).subscribe(u=>{let f;c(),this.hideProgress(),this.r_data=u,this.es.setData(this.r_data),this.loaded=!0,this.render=new renderQueue(C).clear(c),this.es.setRenderer(this.render),this.dMax=d.T9B(this.r_data,D=>+D.tfh)??0,this.es.setDMax(this.dMax),this.render(this.r_data),this.legend.selectAll("rect").empty()||this.legend.selectAll("rect").remove(),this.legend.selectAll("g").empty()||this.legend.selectAll("g").remove(),this.legend.selectAll("text").empty()||this.legend.selectAll("text").remove(),"log"==this.mapScale?f=d.aX1():"sqrt"==this.mapScale?f=d.Bv9():"linear"==this.mapScale&&(f=d.m4Y()),f.domain([0,this.dMax]).range([0,345]);const E=d.V4s(f).ticks(5);this.legend.append("defs").append("linearGradient").attr("id","gradient").attr("x1","0%").attr("y1","0%").attr("x2","0%").attr("y2","100%").selectAll("stop").data([{offset:"0%",color:this.min_color},{offset:"100%",color:this.max_color}]).join("stop").attr("offset",D=>D.offset).attr("stop-color",D=>D.color),this.legend.append("rect").attr("x",50).attr("y",10).attr("width",25).attr("height",345).style("fill","url(#gradient)"),this.legend.append("g").attr("class","x axis").attr("transform","translate(50, 10)").call(E),this.legend.append("text").attr("x",70).attr("y",-78).attr("transform","rotate(90)").text("Apparent Fishing Activity in Hours")}),this.map.on("moveend zoomend",function v(){a.loaded&&a.render(a.r_data)})}onDateChange(e){if(this.range.value.end){const n=new Date(Date.parse(this.range.value.start)),a=new Date(Date.parse(this.range.value.end));this.sliderVal=this.dateToVal(n),this.intervalLength=this.dateRangeToInterval(n,a),this.getData(this.dateToStr(n),this.dateToStr(a)),this.es.getRenderer()(this.es.getData())}}onInputChange(e){this.sliderVal=e.target.value??0;const n=this.valToDate(this.sliderVal),a=this.intervalToEndDate(n);this.range.setValue({start:n,end:a}),this.getData(this.dateToStr(n),this.dateToStr(a))}onCountryChange(e){const n=new Date(Date.parse(this.range.value.start)),a=new Date(Date.parse(this.range.value.end));this.sliderVal=this.dateToVal(n),this.intervalLength=this.dateRangeToInterval(n,a),this.getData(this.dateToStr(n),this.dateToStr(a))}dateToStr(e){return e.getFullYear()+"-"+("0"+(e.getMonth()+1)).slice(-2)+"-"+("0"+e.getDate()).slice(-2)}valToDate(e){const n=new Date(this.maxDate),a=this.sliderMax-e,i=n.valueOf()-1e3*a*60*60*24;return new Date(i)}sliderDisplay(e){const n=this.valToDate(e);return this.dateToStr(n)}dateToVal(e){const n=new Date(this.minDate);return this.dateRangeToInterval(n,e)}truncate(e){return e<0?e=Math.ceil(10*(e-.1))/10:e>=0&&(e=Math.floor(10*e)/10),e}intervalToEndDate(e){let n=new Date(e);return n.setDate(n.getDate()+this.intervalLength),n}dateRangeToInterval(e,n){return Math.round(Math.abs((e.valueOf()-n.valueOf())/864e5))}detSize(e){this.map=this.es.getMap();const n=parseFloat(e.lat),a=parseFloat(e.lon),i=this.map.getZoom();let s,o;2==i?(s=h.latLng(n-.01,a),o=h.latLng(n+.1,a+.1)):3==i?(s=h.latLng(n-.03,a),o=h.latLng(n+.1,a+.1)):4==i?(s=h.latLng(n-.025,a),o=h.latLng(n+.1,a+.1)):5==i?(s=h.latLng(n-.017,a),o=h.latLng(n+.1,a+.1)):6==i?(s=h.latLng(n-.005,a),o=h.latLng(n+.1,a+.1)):7==i?(s=h.latLng(n-.002,a),o=h.latLng(n+.1,a+.1)):(s=h.latLng(n,a),o=h.latLng(n+.1,a+.1));let m=Math.abs(this.map.latLngToContainerPoint(s).x-this.map.latLngToContainerPoint(o).x),g=Math.abs(this.map.latLngToContainerPoint(s).y-this.map.latLngToContainerPoint(o).y);return m=m<1?1:m,g=g<1?1:g,[m,g]}showProgress(){let e=document.getElementById("explProgress");null!=e&&(e.style.visibility="visible")}hideProgress(){let e=document.getElementById("explProgress");null!=e&&(e.style.visibility="hidden")}faoChange(e){const n=this;this.map=this.es.getMap();const a=this.ds.getJson(),i=d.wug({point:function(o,m){const g=n.map.latLngToLayerPoint([m,o]);this.stream.point(g.x,g.y)}}),s=d.zFW().projection(i);if(this.faoChecked){let m=function(){o.attr("d",c=>s(c.geometry))},g=function(c,v){n.faoTooltip.html("FAO Boundary: "+v.properties.NAME_EN+"<br>Ocean: "+v.properties.OCEAN).style("visibility","visible").style("left",c.pageX+5+"px").style("top",c.pageY+5+"px")},C=function(c){n.faoTooltip.style("visibility","hidden")};this.faoSVG=d.Ltv(this.map.getPanes().overlayPane).select("svg");const o=this.faoSVG.append("g").selectAll("path").data(a.features).enter().append("path").attr("d",c=>s(c.geometry)).attr("class","leaflet-interactive").attr("pointer-events","painted").style("fill","lightgrey").style("fill-opacity",0).attr("stroke","black").attr("stroke-opacity",.2);this.faoTooltip=d.Ltv("#tooltip2").attr("class","leaflet-interactive").style("visibility","hidden").style("position","absolute").style("background-color","white").style("border","solid").style("border-width","1px").style("border-radius","5px").style("padding","10px").style("opacity",.7).style("z-index",1e4),o.on("pointermove",g).on("pointerout",C),this.map.on("zoomend",m)}else this.faoChecked||this.faoSVG.selectAll("g").empty()||this.faoSVG.selectAll("g").remove()}static{this.\u0275fac=function(n){return new(n||r)(t.rXU(z.W),t.rXU(Y))}}static{this.\u0275cmp=t.VBU({type:r,selectors:[["app-exploration"]],decls:40,vars:19,consts:[["id","legendECard"],["id","legend"],["id","filter"],["appearance","fill"],[3,"formGroup","min","max","rangePicker"],["matStartDate","","formControlName","start","placeholder","2020-01-01"],["matEndDate","","formControlName","end","placeholder","2020-01-05",3,"dateChange"],["matSuffix","",3,"for"],["picker",""],[4,"ngIf"],["type","text","matInput","","placeholder","World",3,"formControl","matAutocomplete"],["multiple","",3,"optionSelected"],["auto","matAutocomplete"],[3,"value",4,"ngFor","ngForOf"],["appearance","fill",2,"margin-bottom","-1.25em"],[3,"value","valueChange"],["value","linear"],["value","sqrt"],["value","log"],[1,"worldChecked",3,"ngModel","disabled","ngModelChange","change"],["id","slider","discrete","","step","1",3,"displayWith","min","max"],["matSliderThumb","","title","date slider",3,"value","change"],["color","accent","mode","indeterminate","id","explProgress",1,"progress"],["id","map"],["id","tooltip"],["id","tooltip2"],[3,"value"]],template:function(n,a){if(1&n&&(t.j41(0,"mat-card",0),t.qSk(),t.nrm(1,"svg",1),t.k0s(),t.joV(),t.j41(2,"mat-card",2)(3,"mat-form-field",3)(4,"mat-label"),t.EFF(5,"Enter a date range"),t.k0s(),t.j41(6,"mat-date-range-input",4),t.nrm(7,"input",5),t.j41(8,"input",6),t.bIt("dateChange",function(s){return a.onDateChange(s)}),t.k0s()(),t.nrm(9,"mat-datepicker-toggle",7)(10,"mat-date-range-picker",null,8),t.DNE(12,$,2,0,"mat-error",9),t.DNE(13,N,2,0,"mat-error",9),t.k0s(),t.j41(14,"mat-form-field",3)(15,"mat-label"),t.EFF(16,"Select Country"),t.k0s(),t.nrm(17,"input",10),t.j41(18,"mat-autocomplete",11,12),t.bIt("optionSelected",function(s){return a.onCountryChange(s)}),t.DNE(20,X,2,2,"mat-option",13),t.nI1(21,"async"),t.k0s()(),t.j41(22,"mat-form-field",14)(23,"mat-label"),t.EFF(24,"Select Scaling"),t.k0s(),t.j41(25,"mat-select",15),t.bIt("valueChange",function(s){return a.mapScale=s})("valueChange",function(s){return a.onCountryChange(s)}),t.j41(26,"mat-option",16),t.EFF(27,"Linear Scaling"),t.k0s(),t.j41(28,"mat-option",17),t.EFF(29,"Square Root Scaling"),t.k0s(),t.j41(30,"mat-option",18),t.EFF(31,"Logarithmic Scaling"),t.k0s()()(),t.j41(32,"mat-checkbox",19),t.bIt("ngModelChange",function(s){return a.faoChecked=s})("change",function(s){return a.faoChange(s)}),t.EFF(33,"Display FAO Fishing Boundaries"),t.k0s()(),t.j41(34,"mat-slider",20)(35,"input",21),t.bIt("change",function(s){return a.onInputChange(s)}),t.k0s()(),t.nrm(36,"mat-progress-bar",22)(37,"div",23)(38,"div",24)(39,"div",25)),2&n){const i=t.sdS(11),s=t.sdS(19);t.R7$(6),t.Y8G("formGroup",a.range)("min",a.minDate)("max",a.maxDate)("rangePicker",i),t.R7$(3),t.Y8G("for",i),t.R7$(3),t.Y8G("ngIf",a.range.controls.start.hasError("matStartDateInvalid")),t.R7$(1),t.Y8G("ngIf",a.range.controls.end.hasError("matEndDateInvalid")),t.R7$(4),t.Y8G("formControl",a.countryControl)("matAutocomplete",s),t.R7$(3),t.Y8G("ngForOf",t.bMT(21,17,a.filteredOptions)),t.R7$(5),t.Y8G("value",a.mapScale),t.R7$(7),t.Y8G("ngModel",a.faoChecked)("disabled",a.faoDisabled),t.R7$(2),t.Y8G("displayWith",a.sliderDisplay)("min",1)("max",a.sliderMax),t.R7$(1),t.Y8G("value",a.sliderVal)}},dependencies:[T.Sq,T.bT,w.RN,x.rl,x.nJ,x.TL,x.yw,S.IV,S.OU,y.bU,y.el,y.xR,y.IG,y.SG,p.me,p.BC,p.cb,p.l_,p.j4,p.JD,I.VO,F.wT,M.$3,M.pN,R.fg,V.HM,O.So,p.vS,T.Jj],styles:["#map[_ngcontent-%COMP%]{position:fixed;width:100%;height:96.5vh}#filter[_ngcontent-%COMP%]{z-index:999;width:15%;position:absolute;top:6%;right:.5%}#slider[_ngcontent-%COMP%]{position:absolute;z-index:999;width:60%;height:4%;bottom:6%;left:20%}  .mdc-slider__value-indicator{padding:5px!important}mat-form-field[_ngcontent-%COMP%]{width:100%}#legendECard[_ngcontent-%COMP%]{z-index:999;position:absolute;bottom:1.5%;right:.5%}.progress[_ngcontent-%COMP%], #tooltip[_ngcontent-%COMP%]{visibility:hidden}.leaflet-map-pane[_ngcontent-%COMP%]   canvas[_ngcontent-%COMP%]:before{z-index:300}"]})}}return r})()}];let B=(()=>{class r{static{this.\u0275fac=function(n){return new(n||r)}}static{this.\u0275mod=t.$C({type:r})}static{this.\u0275inj=t.G2t({imports:[T.MD,A.iI.forChild(W),w.Hu,x.RG,F.WX,S.Ez,y.X6,p.X1,I.Ve,M.jL,R.fS,V.PO,O.g7,p.YN]})}}return r})()}}]);